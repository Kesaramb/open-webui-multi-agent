# 🗄️ Database Migration Guide: SQLite → PostgreSQL

**Sprint 2:** Upgrading BrandFactory to PostgreSQL for production-grade data persistence

---

## 📊 Current vs New Architecture

### Before (SQLite)
```
Docker Container
└── /app/backend/data/
    └── webui.db (SQLite file)
```

**Limitations:**
- File-based database
- Limited concurrent access
- Not ideal for multiple users
- Harder to backup/restore
- No connection pooling

### After (PostgreSQL)
```
Docker Container                 Render PostgreSQL
└── Application Code    ←────→   brandfactory-db
                                 ├── Users
                                 ├── Chats
                                 ├── Models
                                 └── Settings
```

**Benefits:**
- ✅ Production-grade database
- ✅ Better concurrent access
- ✅ Automatic backups (Render)
- ✅ Connection pooling
- ✅ Better performance at scale
- ✅ ACID compliance

---

## 🎯 What's Changing

### Database Configuration

**Old (SQLite):**
```yaml
disk:
  name: openwebui-data
  mountPath: /app/backend/data
  sizeGB: 10
```

**New (PostgreSQL):**
```yaml
databases:
  - name: brandfactory-db
    databaseName: openwebui
    user: openwebui
    plan: starter  # Free tier

services:
  - type: web
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: brandfactory-db
          property: connectionString
```

### Environment Variables

**Added:**
- `DATABASE_URL` - PostgreSQL connection string (auto-generated by Render)

**Format:**
```
postgresql://openwebui:password@dpg-xxxxx.oregon-postgres.render.com/openwebui
```

---

## ⚠️ Important: Data Migration

### Option 1: Fresh Start (Recommended for New Deployments)

If you haven't created important data yet:

1. **Delete old SQLite data** (automatic on new deploy)
2. **PostgreSQL starts fresh**
3. **Create new account**
4. **Recreate AI personas** (use personas_modelfiles.txt)

**Pros:**
- Clean start
- No migration complexity
- Faster deployment

**Cons:**
- Lose any existing chats/settings

---

### Option 2: Migrate Existing Data (Advanced)

If you have important chats/data in SQLite:

#### Step 1: Backup Current SQLite Database

```bash
# From Render shell (not available on free tier)
# OR download via Render dashboard (Disk backups)
```

#### Step 2: Use Migration Tool

Open WebUI supports automatic migration when DATABASE_URL is set. It will:
1. Detect existing SQLite database
2. Create PostgreSQL schema
3. Migrate all data
4. Switch to PostgreSQL

**Migration happens automatically on first startup with DATABASE_URL set!**

---

## 🚀 Deployment Steps

### Step 1: Review Changes

```bash
git diff render.yaml
```

You should see:
- New `databases:` section
- New `DATABASE_URL` environment variable

### Step 2: Commit and Push

```bash
git add render.yaml
git commit -m "feat: Migrate from SQLite to PostgreSQL

- Add brandfactory-db PostgreSQL database (starter plan)
- Configure DATABASE_URL environment variable
- Keep persistent disk for uploads/models
- Automatic migration on first startup"

git push
```

### Step 3: Render Will Auto-Deploy

Render will:
1. **Create PostgreSQL database** (brandfactory-db)
2. **Rebuild Docker container** with DATABASE_URL
3. **Run migrations** automatically
4. **Start application** with PostgreSQL

**Timeline:** ~10-15 minutes

---

## ✅ Verification Steps

### 1. Check Database Creation

**Render Dashboard:**
1. Go to https://dashboard.render.com
2. Click "PostgreSQL" in sidebar
3. Verify "brandfactory-db" exists
4. Status should be "Available"

### 2. Check Environment Variables

**In your service:**
1. Click "brandfactory" service
2. Go to "Environment" tab
3. Verify `DATABASE_URL` is set (value hidden for security)

### 3. Test Application

```bash
# Check if site loads
curl -I https://gobrandfactory.com

# Check API
curl -s https://gobrandfactory.com/api/config | jq

# Test login
# Visit https://gobrandfactory.com
# Click "Launch Workspace"
# Sign up / Sign in
# Verify you can create chats
```

### 4. Check Database Connection

**In Render logs:**

Look for these messages:
```
INFO [alembic.runtime.migration] Running upgrade ...
INFO [root] Connected to PostgreSQL database
INFO Application startup complete
```

**No more SQLite messages like:**
```
Connected to SQLite at /app/backend/data/webui.db
```

---

## 📊 Database Plans & Pricing

### Render PostgreSQL Plans

| Plan | RAM | Storage | Connections | Cost | Best For |
|------|-----|---------|-------------|------|----------|
| **Starter** | 256MB | 1GB | 97 | **FREE** | Testing, small projects |
| **Basic** | 1GB | 10GB | 97 | $7/mo | Production (recommended) |
| **Standard** | 4GB | 50GB | 197 | $20/mo | High traffic |

**Current Configuration:** Starter (FREE)

**Recommendation:** Start with Starter, upgrade to Basic ($7/mo) when you have:
- 10+ active users
- 1000+ chats stored
- Need better performance

---

## 🔧 Troubleshooting

### Issue 1: "Connection refused"

**Symptom:**
```
ERROR: could not connect to database
```

**Fix:**
1. Check DATABASE_URL is set correctly
2. Verify database is "Available" in Render dashboard
3. Check database and service are in same region

---

### Issue 2: "Database does not exist"

**Symptom:**
```
FATAL: database "openwebui" does not exist
```

**Fix:**
Database name in render.yaml must match:
```yaml
databases:
  - name: brandfactory-db
    databaseName: openwebui  # Must match!
```

---

### Issue 3: Migration Stuck

**Symptom:**
Application starts but hangs on "Running migrations..."

**Fix:**
1. Check Render logs for specific error
2. Verify PostgreSQL version compatibility
3. May need to manually run migrations

---

### Issue 4: Performance Slower Than SQLite

**Cause:**
Starter plan (256MB) may be slower for complex queries

**Fix:**
Upgrade to Basic plan ($7/mo):
```yaml
databases:
  - name: brandfactory-db
    plan: basic  # 1GB RAM, 10GB storage
```

---

## 🔄 Rollback Plan

If something goes wrong, you can rollback:

### Option 1: Revert Git Changes

```bash
git revert HEAD
git push
```

This will:
- Remove DATABASE_URL
- Fall back to SQLite
- Redeploy previous version

### Option 2: Manual Revert

1. Go to Render dashboard
2. Delete DATABASE_URL environment variable
3. Trigger manual deploy

---

## 🎓 Best Practices

### 1. Backups

**Automatic Backups (Render):**
- Starter plan: No automatic backups
- Basic plan: Daily backups, 7-day retention
- Standard plan: Daily backups, 30-day retention

**Manual Backups:**
```bash
# From Render PostgreSQL dashboard
# Click "Backups" → "Create Backup"
```

### 2. Connection Management

Open WebUI handles connection pooling automatically via DATABASE_URL.

### 3. Monitoring

**Watch these metrics in Render dashboard:**
- Database size (GB used)
- Active connections
- Query performance
- Memory usage

**Set alerts for:**
- Storage >80% full
- Connection limit reached
- High query latency

### 4. Scaling Strategy

**When to upgrade:**
- **Storage >800MB:** Upgrade to Basic
- **Slow queries:** Upgrade to Basic (more RAM)
- **Connection errors:** Upgrade to Standard (more connections)

---

## 📈 Performance Comparison

### Expected Improvements

| Metric | SQLite | PostgreSQL | Improvement |
|--------|--------|------------|-------------|
| **Concurrent Users** | 1-5 | 50+ | 10x |
| **Write Speed** | Good | Excellent | 2x |
| **Query Speed** | Fast | Fast | Similar |
| **Backup Time** | Minutes | Seconds | 10x |
| **Recovery Time** | Manual | Automatic | Instant |

---

## 🔐 Security

### Database Access

**Credentials:**
- Automatically generated by Render
- Stored securely in DATABASE_URL
- Never committed to Git
- Rotatable via Render dashboard

### Network Security

- Database accessible only from your Render service
- SSL/TLS encryption in transit
- No public internet access

### Best Practices

1. ✅ Never commit DATABASE_URL to Git
2. ✅ Use environment variables
3. ✅ Rotate credentials periodically
4. ✅ Enable backups (Basic plan+)
5. ✅ Monitor access logs

---

## 📚 Additional Resources

- **Render PostgreSQL Docs:** https://render.com/docs/databases
- **Open WebUI Database Docs:** https://docs.openwebui.com/getting-started/env-configuration/
- **PostgreSQL Best Practices:** https://www.postgresql.org/docs/current/

---

## ✅ Migration Checklist

- [ ] Review render.yaml changes
- [ ] Backup existing data (if needed)
- [ ] Commit and push changes
- [ ] Wait for Render deployment (~10-15 min)
- [ ] Verify database created in Render dashboard
- [ ] Check DATABASE_URL environment variable
- [ ] Test application login and functionality
- [ ] Create test chat to verify data persistence
- [ ] Monitor logs for any errors
- [ ] Set up database backups (if Basic plan+)
- [ ] Document any customizations

---

## 🎯 Success Criteria

Your migration is successful when:

✅ PostgreSQL database shows "Available" in Render
✅ APPLICATION connects successfully (check logs)
✅ You can sign up / sign in
✅ Chats are created and persisted
✅ AI personas work correctly
✅ No SQLite references in logs

---

## 📞 Support

**Issues?**
- Check Render logs: https://dashboard.render.com
- Review this guide's troubleshooting section
- Check Open WebUI discussions: https://github.com/open-webui/open-webui/discussions

---

**Ready to migrate? Follow the deployment steps above!** 🚀

*Next: After successful migration, consider upgrading to Basic plan ($7/mo) for automatic backups*
